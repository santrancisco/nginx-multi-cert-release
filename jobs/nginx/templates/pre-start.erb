#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

export SSL_CERT_LOCATION=<%= p('ssl.cert_folder') %>
export NGINX_CONFIG_LOCATION=<%= p('ssl.nginx_conf_folder') %>

if [ ! -d $SSL_CERT_LOCATION ]; then
  mkdir -p $SSL_CERT_LOCATION
fi

if [ ! -d $NGINX_CONFIG_LOCATION ]; then
  mkdir -p $NGINX_CONFIG_LOCATION
fi


echo "deleting old keys"
#rm $SSL_CERT_LOCATION/*.key $SSL_CERT_LOCATION/*.cert;

<%
p('ssl.certs').each do |cert|
%>

echo -n "<%= cert["fullchain"] %>" > /${SSL_CERT_LOCATION}/<%= cert["name"] %>.chained.crt
echo -n "<%= cert["private_key"] %>" > /${SSL_CERT_LOCATION}/<%= cert["name"] %>.key
echo -n "<%= cert["certificate"] %>" > /${SSL_CERT_LOCATION}/<%= cert["name"] %>.crt
echo -n "<%= cert["conf"] %>" > /${NGINX_CONFIG_LOCATION}/<%= cert["name"] %>.conf

<% end %>
